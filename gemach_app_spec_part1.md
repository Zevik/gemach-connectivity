# מרכז הגמ"חים - מפרט אפליקציה (חלק 1)

## 1. כללי

### 1.1 מטרת המערכת
מערכת "מרכז הגמ"חים" נועדה לשמש כפלטפורמה מרכזית לניהול וחיפוש גמ"חים (גמילות חסדים) שונים. המערכת מאפשרת למשתמשים לחפש גמ"חים לפי קטגוריות, מיקום וקריטריונים נוספים, וכן מאפשרת לבעלי גמ"חים לרשום ולנהל את הגמ"חים שלהם במערכת.

### 1.2 קהל היעד
- משתמשים המחפשים שירותי גמ"ח
- בעלי ומנהלי גמ"חים
- מנהלי המערכת (אדמינים)

### 1.3 טכנולוגיות
- **צד לקוח**: React.js, TypeScript, Tailwind CSS, Shadcn/UI
- **צד שרת**: Supabase (PostgreSQL)
- **אחסון קבצים**: Supabase Storage
- **אימות משתמשים**: Supabase Auth

## 2. מבנה המערכת

### 2.1 ארכיטקטורה כללית
המערכת תהיה מבוססת על ארכיטקטורת SPA (Single Page Application) עם React בצד הלקוח ו-Supabase בצד השרת. התקשורת תתבצע באמצעות REST API של Supabase.

### 2.2 מבנה הנתונים

#### 2.2.1 טבלאות מסד הנתונים

##### טבלת profiles
```sql
CREATE TABLE profiles (
  id UUID REFERENCES auth.users PRIMARY KEY,
  full_name TEXT NOT NULL,
  email TEXT UNIQUE NOT NULL,
  phone TEXT,
  neighborhood TEXT,
  avatar_url TEXT,
  is_admin BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

##### טבלת gemachs
```sql
CREATE TABLE gemachs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  owner_id UUID REFERENCES profiles(id) NOT NULL,
  name TEXT NOT NULL,
  category TEXT NOT NULL,
  neighborhood TEXT NOT NULL,
  address TEXT NOT NULL,
  phone TEXT NOT NULL,
  manager_phone TEXT,
  email TEXT,
  website TEXT,
  description TEXT NOT NULL,
  operating_hours JSONB NOT NULL,
  requires_payment BOOLEAN DEFAULT FALSE,
  special_conditions TEXT,
  average_rating NUMERIC(2,1) DEFAULT 0,
  review_count INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

##### טבלת gemach_images
```sql
CREATE TABLE gemach_images (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  gemach_id UUID REFERENCES gemachs(id) ON DELETE CASCADE NOT NULL,
  image_path TEXT NOT NULL,
  image_url TEXT NOT NULL,
  is_primary BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

##### טבלת reviews
```sql
CREATE TABLE reviews (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  gemach_id UUID REFERENCES gemachs(id) ON DELETE CASCADE NOT NULL,
  user_id UUID REFERENCES profiles(id) NOT NULL,
  rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
  comment TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(gemach_id, user_id)
);
```

#### 2.2.2 Row Level Security (RLS)

##### Gemachs
```sql
-- Allow public read access to approved gemachs
CREATE POLICY "Allow public read access to approved gemachs"
ON gemachs FOR SELECT
TO public
USING (is_approved = true);

-- Allow owners to update their own gemachs
CREATE POLICY "Allow owners to update their own gemachs"
ON gemachs FOR UPDATE
TO authenticated
USING (auth.uid() = owner_id)
WITH CHECK (auth.uid() = owner_id);

-- Allow owners to delete their own gemachs
CREATE POLICY "Allow owners to delete their own gemachs"
ON gemachs FOR DELETE
TO authenticated
USING (auth.uid() = owner_id);
```

##### Images
```sql
-- Allow public read access to images
CREATE POLICY "Allow public read access to images"
ON gemach_images FOR SELECT
TO public
USING (true);

-- Allow owners to insert images for their gemachs
CREATE POLICY "Allow owners to insert images for their gemachs"
ON gemach_images FOR INSERT
TO authenticated
WITH CHECK (
  EXISTS (
    SELECT 1 FROM gemachs
    WHERE gemachs.id = gemach_images.gemach_id
    AND gemachs.owner_id = auth.uid()
  )
);
```

## 3. ממשק משתמש ודפים

### 3.1 דף הבית (Index.tsx)
**מטרה**: הצגת מידע כללי על הפלטפורמה ואפשרויות הניווט למגוון הדפים.

**רכיבים**:
- כותרת ראשית עם סלוגן
- קצת מידע על המערכת
- חיפוש מהיר לגמ"חים
- גמ"חים מובילים או מומלצים
- קריאה לפעולה לרישום גמ"ח חדש
- קישורים מהירים לקטגוריות פופולריות

**עיצוב**:
- עיצוב מודרני ונקי
- רקע בהיר עם קונטרסט טוב
- צבע בסיס: כחול נייבי (#1E40AF)
- צבע משני: תכלת (#3B82F6)
- שימוש בכרטיסיות (cards) להצגת מידע

**חווית משתמש**:
- חיפוש מהיר וקל
- גישה מהירה לקטגוריות נפוצות
- כפתורים ברורים לניווט

### 3.2 דף חיפוש גמ"חים (SearchGemachs.tsx)
**מטרה**: חיפוש גמ"חים על פי קריטריונים שונים.

**רכיבים**:
- טופס חיפוש מתקדם עם:
  - שדה טקסט חופשי לחיפוש
  - בחירת קטגוריה (dropdown)
  - בחירת שכונה/אזור (dropdown)
  - סינון לפי מאפיינים (מחיר, שעות פעילות וכו')
- רשימת תוצאות חיפוש
- מפה אינטראקטיבית (אופציונלי)
- אפשרות מיון תוצאות

**עיצוב**:
- מסנן בצד ימין
- תוצאות במרכז/שמאל בתצוגת רשימה או גריד
- כרטיסיות לכל תוצאה עם תמונה, שם, כתובת וקטגוריה

**חווית משתמש**:
- פילטרים דינמיים שמשתנים בזמן אמת
- טעינה הדרגתית של תוצאות (infinite scroll)
- אפשרות צפייה במפה (אם הוגדרו נ.צ. לגמ"חים)

### 3.3 עמוד גמ"ח בודד (GemachDetails.tsx)
**מטרה**: הצגת מידע מפורט על גמ"ח ספציפי.

**רכיבים**:
- שם הגמ"ח
- תמונות (גלריה)
- פרטי יצירת קשר (טלפון, מייל, וכו')
- כתובת מלאה
- שעות פעילות
- תיאור מפורט
- מפה עם מיקום
- ביקורות משתמשים
- פרטי תשלום/עלויות (אם יש)
- קישורים לאתר/רשתות חברתיות (אם יש)

**עיצוב**:
- תמונה גדולה בראש העמוד
- פרטים עיקריים במסגרת בולטת
- חלוקה לסקציות ברורות
- כפתורי פעולה (צור קשר, דרך הגעה, שיתוף)

**חווית משתמש**:
- אפשרות לשליחת הודעה ישירה למנהל (אם מחובר)
- אפשרות הוספת ביקורת (אם מחובר)
- צפייה בדרכי הגעה מהמיקום הנוכחי

### 3.4 דף רישום גמ"ח (RegisterGemach.tsx)
**מטרה**: רישום גמ"ח חדש במערכת.

**רכיבים**:
- טופס מפורט הכולל:
  - שם הגמ"ח
  - קטגוריה
  - שכונה
  - כתובת מדויקת
  - הוראות הגעה
  - טלפון ראשי
  - טלפון חלופי
  - אימייל
  - תיאור
  - שעות פעילות
  - מידע על תשלומים (אם יש)
  - אתר אינטרנט ורשתות חברתיות
  - העלאת תמונות

**עיצוב**:
- טופס מחולק לסקציות
- הדגשת שדות חובה
- אינדיקציה ויזואלית למצב התקדמות המילוי
- אנימציות מעבר בין שלבים

**חווית משתמש**:
- הודעות שגיאה ברורות ובזמן אמת
- שמירת טיוטא אוטומטית
- אפשרות לתצוגה מקדימה לפני שליחה
- מסך אישור לאחר שליחה מוצלחת

### 3.5 פרופיל משתמש (UserProfile.tsx)
**מטרה**: ניהול פרופיל והגמ"חים של המשתמש.

**רכיבים**:
- פרטי משתמש וכפתור עריכה
- רשימת הגמ"חים של המשתמש
- סטטוס אישור לכל גמ"ח
- סטטיסטיקות צפייה (אופציונלי)
- היסטוריית פעילות

**עיצוב**:
- כרטיסיית פרופיל בראש
- טאבים לניווט בין התוכן השונה
- צבעים מובחנים לסטטוס שונה (ממתין לאישור, מאושר, נדחה)

**חווית משתמש**:
- עריכה מהירה של פרטים
- התראות על שינוי סטטוס
- אפשרות סינון והצגת הגמ"חים

### 3.6 דף התחברות ורישום (Auth.tsx)
**מטרה**: התחברות ורישום משתמשים למערכת.

**רכיבים**:
- טופס התחברות עם אימייל וסיסמה
- טופס רישום משתמש חדש
- התחברות באמצעות Google
- קישור לאיפוס סיסמה

**עיצוב**:
- טופס נקי ומינימליסטי
- אנימציה למעבר בין התחברות לרישום
- לוגו גדול ומיתוג של המערכת

**חווית משתמש**:
- טפסים קצרים ופשוטים
- הודעות שגיאה ברורות
- אפשרויות התחברות מגוונות
- זכירת פרטי התחברות

### 3.7 לוח מנהל (AdminDashboard.tsx)
**מטרה**: ניהול גמ"חים, משתמשים ותוכן המערכת.

**רכיבים**:
- סטטיסטיקות כלליות
- רשימת גמ"חים ממתינים לאישור
- רשימת משתמשים
- ניהול קטגוריות ושכונות
- דוחות וסטטיסטיקות

**עיצוב**:
- מסך מחולק לאזורים ברורים
- טבלאות עם אפשרויות סינון וחיפוש
- גרפים ויזואליים להצגת נתונים

**חווית משתמש**:
- פעולות מהירות (אישור/דחייה)
- חיפוש וסינון מתקדם
- ייצוא נתונים לפורמטים שונים

### 3.8 דף עזרה ותמיכה (Support.tsx)
**מטרה**: מתן מידע ועזרה למשתמשים.

**רכיבים**:
- שאלות נפוצות (FAQ)
- טופס יצירת קשר
- מדריכי שימוש
- מידע משפטי (תנאי שימוש ופרטיות)

**עיצוב**:
- ממשק מסודר ומחולק לקטגוריות
- אקורדיונים לשאלות נפוצות
- דוגמאות ויזואליות

**חווית משתמש**:
- חיפוש בשאלות נפוצות
- טופס יצירת קשר פשוט ונגיש
- אפשרות להצעת שיפורים

## 4. קומפוננטות משותפות

### 4.1 Header.tsx
**מטרה**: ניווט עיקרי ותצוגת סטטוס התחברות.

**רכיבים**:
- לוגו
- תפריט ניווט ראשי
- חיפוש מהיר
- כפתורי התחברות/הרשמה או פרופיל משתמש
- תפריט נפתח למשתמשים מחוברים

**עיצוב**:
- צבע רקע כהה (כחול נייבי)
- טקסט לבן קריא
- אייקונים ברורים
- רספונסיבי עם תפריט המבורגר במסכים קטנים

### 4.2 Footer.tsx
**מטרה**: מידע נוסף וקישורים משניים.

**רכיבים**:
- זכויות יוצרים
- קישורים משניים (תנאי שימוש, פרטיות)
- קישורי רשתות חברתיות
- פרטי יצירת קשר
- לוגו קטן

**עיצוב**:
- רקע כהה
- טקסט בהיר
- אייקונים של רשתות חברתיות
- חלוקה לעמודות במסכים גדולים

### 4.3 GemachCard.tsx
**מטרה**: תצוגת תקציר של גמ"ח ברשימות ותוצאות חיפוש.

**רכיבים**:
- תמונה ממוזערת
- שם הגמ"ח
- קטגוריה
- שכונה
- דירוג כוכבים
- תצוגת מרחק (אם זמין)
- תגיות נוספות (חדש, מומלץ וכו')

**עיצוב**:
- כרטיסייה בעיצוב מלבני או ריבועי
- צללית קלה
- אנימציית hover
- קונטרסט טוב בין תמונה לטקסט

### 4.4 SearchFilters.tsx
**מטרה**: סינון תוצאות חיפוש.

**רכיבים**:
- שדות חיפוש (טקסט, קטגוריה, שכונה)
- סינון מתקדם (מרחק, דירוג, מחיר)
- אפשרויות מיון

**עיצוב**:
- ממשק קומפקטי
- אפשרות לכיווץ והרחבה של אפשרויות מתקדמות
- אינדיקציה ויזואלית לפילטרים פעילים

### 4.5 ReviewComponent.tsx
**מטרה**: הצגת והוספת ביקורות.

**רכיבים**:
- תצוגת ביקורות קיימות
- טופס הוספת ביקורת חדשה
- מערכת דירוג כוכבים
- אפשרות לתגובה לביקורות (אופציונלי)

**עיצוב**:
- הפרדה ויזואלית בין ביקורות
- הדגשת דירוג
- אינדיקציה למשתמש שכתב את הביקורת

### 4.6 ImageUploader.tsx
**מטרה**: העלאת וניהול תמונות.

**רכיבים**:
- אזור גרירה והשלכת קבצים
- תצוגה מקדימה
- סטטוס העלאה
- אפשרות מחיקה

**עיצוב**:
- אזור מסומן בגבול מקווקו
- אנימציה בזמן גרירה
- סרגל התקדמות בזמן העלאה

## 5. לוגיקת האפליקציה

### 5.1 ניהול הרשאות
**משתמש רגיל**:
- צפייה בגמ"חים מאושרים
- חיפוש וסינון
- הוספת ביקורות
- רישום גמ"ח חדש (טעון אישור)
- עריכת גמ"חים שלו

**מנהל (אדמין)**:
- צפייה בכל הגמ"חים (כולל אלה שממתינים לאישור)
- אישור/דחיית גמ"חים חדשים
- עריכת כל הגמ"חים
- ניהול משתמשים
- הגדרות מערכת
- צפייה בסטטיסטיקות ודוחות

### 5.2 תהליך רישום גמ"ח
1. משתמש מחובר ממלא טופס רישום גמ"ח
2. המערכת מבצעת ולידציה לשדות
3. הנתונים נשמרים בטבלת gemachs עם סטטוס is_approved = false
4. מנהל המערכת מקבל התראה
5. לאחר אישור מנהל, הגמ"ח מוצג במערכת

### 5.3 מנגנון חיפוש
1. המשתמש מזין פרמטרים לחיפוש
2. המערכת בונה שאילתת SQL עם הפרמטרים הרלוונטיים
3. תוצאות מוצגות בתצוגת רשימה/גריד
4. המשתמש יכול לסנן ולמיין את התוצאות
5. עמוד התוצאות תומך בטעינה הדרגתית (20 תוצאות בכל פעם)

### 5.4 מנגנון אימות משתמשים
**רישום**:
- הרשמה עם אימייל וסיסמה
- אימות מייל (אופציונלי)
- רישום באמצעות חשבון Google

**התחברות**:
- התחברות עם אימייל וסיסמה
- התחברות באמצעות Google
- אפשרות 'זכור אותי'
- שחזור סיסמה

### 5.5 ניהול הרשאות משתמשים

**תיאור כללי**: המערכת מנהלת הרשאות משתמשים לפי רמות שונות, עם דגש מיוחד על הבחנה בין משתמשים רגילים ומנהלי מערכת (אדמין).

#### 5.5.1 רמות הרשאה
- **משתמש אנונימי**: יכול לצפות בגמ"חים מאושרים וחיפוש.
- **משתמש רשום**: יכול ליצור גמ"חים, לערוך גמ"חים שלו, להוסיף ביקורות.
- **מנהל מערכת (אדמין)**: כל ההרשאות של משתמש רגיל, בנוסף:
  - צפייה, אישור ודחיית גמ"חים ממתינים
  - עריכה ומחיקה של כל הגמ"חים במערכת (גם של משתמשים אחרים)
  - הוספה והסרה של משתמשים אחרים כמנהלי מערכת
  - צפייה במידע סטטיסטי על המערכת

#### 5.5.2 הקצאת הרשאות אדמין
1. **בזמן הרשמה**: 
   - משתמשים עם דוא"ל מוגדר מראש (למשל, zaviner@gmail.com) מקבלים אוטומטית הרשאות אדמין.
   - ניתן להגדיר בקונפיגורציה רשימה של דוא"לים שיקבלו הרשאות אדמין אוטומטית.

2. **לאחר הרשמה**:
   - אדמין קיים יכול להעניק הרשאות אדמין למשתמש קיים דרך ממשק הניהול.
   - ההרשאות נשמרות בטבלת `profiles` ובמטא-דאטה של המשתמש.

3. **הסרת הרשאות**:
   - אדמין יכול להסיר הרשאות מנהל מאדמין אחר (למעט מנהל-על המוגדר במערכת).

#### 5.5.3 יישום טכני של מערכת ההרשאות
- שימוש ב-Row Level Security (RLS) בבסיס הנתונים
- בדיקת הרשאות אדמין דרך פונקציית SQL `is_admin()`
- הגדרת הרשאות אדמין דרך פונקציית SQL `set_user_admin()`
- שמירת סטטוס אדמין בצורה מרובה:
  1. בטבלת `profiles` בשדה `is_admin`
  2. במטא-דאטה של המשתמש בטבלת `auth.users`
  3. בקונטקסט של אובייקט המשתמש בצד הלקוח

### 5.6 לוח בקרה למנהל מערכת

**תיאור כללי**: לוח הבקרה למנהל מערכת מאפשר ניהול מקיף של תוכן האתר והמשתמשים.

#### 5.6.1 דף הבקרה הראשי
- **סטטיסטיקות כלליות**:
  - מספר גמ"חים פעילים
  - משתמשים רשומים
  - גמ"חים ממתינים לאישור
  - פעילות אחרונה

#### 5.6.2 ניהול גמ"חים
- **רשימת גמ"חים ממתינים לאישור**:
  - תצוגת פרטי הגמ"ח (שם, קטגוריה, תיאור, יוצר)
  - כפתורי אישור/דחייה
  - קישור לצפייה מלאה בגמ"ח

- **ניהול גמ"חים קיימים**:
  - חיפוש וסינון גמ"חים
  - עריכה ומחיקה
  - הסרת אישור (השבתה זמנית)

#### 5.6.3 ניהול משתמשים
- **רשימת משתמשים**:
  - חיפוש לפי שם/אימייל
  - מידע על תאריך הרשמה וכמות גמ"חים

- **ניהול מנהלי מערכת**:
  - הוספת משתמש קיים כמנהל מערכת
  - הסרת הרשאות מנהל
  - צפייה ברשימת המנהלים הקיימים

#### 5.6.4 ממשק לוח הבקרה
- **תצוגה**: לשוניות מפרידות בין תחומי הניהול השונים
- **התאמה אישית**: אפשרות לקבוע אילו מדדים יופיעו בלוח הבקרה
- **התראות**: התראות על גמ"חים חדשים הממתינים לאישור
- **סינון וחיפוש**: כלים מתקדמים לסינון וחיפוש בכל הרשימות

#### 5.6.5 פעולות המנהל
- **אישור גמ"ח**: בדיקת תקינות המידע, תמונות, ותוכן, ולאחר מכן אישור להופעה באתר
- **עריכת גמ"ח**: תיקון מידע שגוי או לא מתאים
- **הוספת מנהל**: הענקת הרשאות מנהל למשתמש קיים על ידי הזנת אימייל
- **הסרת מנהל**: ביטול הרשאות מנהל (למעט מנהל-על המוגדר במערכת)

### 5.7 ניהול תמונות
1. העלאת תמונות לשרת Supabase Storage
2. שמירת נתיב התמונה בטבלת gemach_images
3. הצגת תמונות עם URL ציבורי
4. תמיכה בתמונה ראשית ותמונות נוספות

## 6. אבטחה

### 6.1 הרשאות RLS (Row Level Security)
- הגדרת מדיניות אבטחה בשכבת הנתונים בסופאבייס
- הפרדת הרשאות לפי תפקיד משתמש (אנונימי, מחובר, אדמין)
- אבטחת גישה לתמונות בשרת האחסון
- הגבלת עריכה לבעלי גמ"חים בלבד

### 6.2 ולידציה
- ולידציה צד לקוח עם Zod
- ולידציה צד שרת בסופאבייס
- סניטציה של קלט למניעת XSS והזרקת SQL

## 7. UI/UX תפיסת

### 7.1 צבעים וטיפוגרפיה
**צבעים**:
- צבע ראשי: כחול נייבי (#1E40AF)
- צבע משני: תכלת (#3B82F6)
- אקצנט: כתום (#F97316)
- רקע: לבן-אפור בהיר (#F9FAFB)
- טקסט: שחור רך (#111827)
- קישורים: כחול (#2563EB)
- הצלחה: ירוק (#10B981)
- אזהרה: צהוב (#F59E0B)
- שגיאה: אדום (#EF4444)

**פונטים**:
- כותרות: Heebo (או שקול)
- טקסט: Assistant (או שקול)

**גדלים**:
- כותרת ראשית: 2.5rem (40px)
- כותרת משנית: 1.875rem (30px)
- כותרת קטנה: 1.25rem (20px)
- טקסט רגיל: 1rem (16px)
- טקסט קטן: 0.875rem (14px)

### 7.2 סגנון עיצוב כללי
- מינימליסטי ונקי
- כרטיסיות עם צללים עדינים
- רדיוס פינות עקבי (8px)
- שימוש בחללים לבנים (white space) להפרדה ויזואלית
- אנימציות מעבר עדינות (0.2s ease-in-out)
- זרימה מימין לשמאל (RTL)
- אייקונים ממשפחת עיצוב אחידה

### 7.3 רספונסיביות
- תכנון mobile-first עם נקודות שבירה:
  - מובייל: 0-640px
  - טאבלט: 641px-1024px
  - מחשב: 1025px ומעלה
- התאמת תצוגה לכל גודל מסך:
  - תפריט המבורגר במובייל
  - תצוגת גריד משתנה
  - הסתרת/שינוי רכיבים לא חיוניים במסכים קטנים

## 8. נתונים סטטיים

### 8.1 קטגוריות
- כלי עבודה וגינה
- ציוד לאירועים
- ציוד לתינוקות וילדים
- ציוד רפואי
- מוצרי חשמל
- ספרים ומשחקים
- ריהוט
- כלי בית
- ציוד קודש
- ציוד לימוד
- ביגוד
- אוכל (מזון יבש)
- הלוואות כספיות
- שונות

### 8.2 שכונות/אזורים
- רמות
- סנהדריה
- גאולה
- מאה שערים
- רמת אשכול
- קרית משה
- בית וגן
- הר נוף
- רמת שלמה
- מרכז העיר
- בית ישראל
- מקור ברוך
- שערי חסד
- קטמון
- תלפיות
- בקעה
- רמת דניה
- נווה יעקב
- פסגת זאב
- גבעת שאול
- גבעת מרדכי
- מחוץ לירושלים 