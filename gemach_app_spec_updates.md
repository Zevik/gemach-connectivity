# עדכוני מערכת מרכז הגמ"חים

## 1. שיפורים בממשק המנהל

### 1.1 ניהול גמ"חים מורחב
נוספה אפשרות למנהלי המערכת לערוך או למחוק כל גמ"ח במערכת, גם כאלה שנוצרו על ידי משתמשים אחרים. שיפור זה מאפשר למנהלים לבצע תיקונים ושינויים בתוכן ללא תלות בבעלים המקוריים של הגמ"ח.

#### שינויים בממשק:
- **דף פרטי גמ"ח**: נוסף אזור פעולות ניהול למנהלים המציג כפתורי עריכה והעברה לסל מחזור
- **דף ניהול מערכת**: הורחב כדי לכלול טאבים עם גישה לכל הגמ"חים במערכת
- **דף ניהול תוכן**: כל מקום בממשק שבו מופיע גמ"ח מאפשר למנהל לערוך אותו

### 1.2 טאב גמ"חים מאושרים
נוסף טאב חדש בדף הניהול המאפשר צפייה ברשימת כל הגמ"חים המאושרים במערכת. המנהל יכול לבצע פעולות עריכה ומחיקה על כל גמ"ח ברשימה.

#### שינויים בממשק:
- טאב חדש "גמ"חים מאושרים" בדף הניהול
- תצוגת טבלה של כל הגמ"חים המאושרים
- כפתורי פעולות: צפייה, עריכה, והעברה לסל מחזור

## 2. מערכת סל המחזור

### 2.1 סקירה כללית
מערכת סל המחזור מאפשרת למנהלי המערכת לנהל גמ"חים באופן יעיל יותר תוך שמירה על היסטוריית פעולות מחיקה. במקום מחיקה מוחלטת, גמ"חים מועברים תחילה לסל מחזור המאפשר שחזור במקרה הצורך או מחיקה סופית.

### 2.2 מודל נתונים
למודל הנתונים של טבלת `gemachs` נוספו שדות חדשים:

```sql
ALTER TABLE gemachs
ADD COLUMN is_deleted BOOLEAN DEFAULT NULL,
ADD COLUMN deleted_at TIMESTAMPTZ DEFAULT NULL;
```

כאשר:
- `is_deleted` - סטטוס המציין אם הגמ"ח נמצא בסל המחזור (`true`) או לא (`null` או `false`)
- `deleted_at` - תאריך ושעת העברת הגמ"ח לסל המחזור

### 2.3 פונקציונליות סל המחזור

#### 2.3.1 העברת גמ"ח לסל המחזור
- מנהלי מערכת יכולים להעביר גמ"ח לסל המחזור מכל אחד מממשקי הניהול
- פעולת המחיקה בממשקי הניהול השונים שונתה ל"מחיקה רכה" (soft delete)
- משתמשים רגילים המוחקים גמ"ח שלהם גם מבצעים העברה לסל מחזור במקום מחיקה מוחלטת

#### 2.3.2 ממשק סל המחזור
- טאב ייעודי בדף ניהול המערכת עבור סל המחזור
- הצגת כל הגמ"חים שהועברו לסל המחזור עם פרטי בסיס ותאריך המחיקה
- פעולות אפשריות:
  - צפייה בפרטי הגמ"ח
  - שחזור הגמ"ח
  - מחיקה סופית של הגמ"ח

#### 2.3.3 שחזור גמ"ח
- אפשרות לשחזר גמ"ח שהועבר לסל המחזור
- עדכון שדות `is_deleted` ו-`deleted_at` ל-`null`
- הגמ"ח יחזור למצבו הקודם (מאושר או ממתין לאישור)

#### 2.3.4 מחיקה סופית
- אפשרות למחוק לצמיתות גמ"ח מסל המחזור (מחיקה פיזית מהמסד נתונים)
- פעולה זו אינה ניתנת לביטול ודורשת אישור נוסף מהמשתמש

### 2.4 השפעה על מערכות קיימות

#### 2.4.1 תצוגות גמ"חים
- כל השאילתות במערכת עודכנו להציג רק גמ"חים שאינם בסל המחזור
- בדף הראשי: נוסף תנאי `is_deleted IS NULL` לשאילתת הגמ"חים
- בדף המשתמש: נוספו תנאים לכל השאילתות להחריג גמ"חים שנמחקו
- בדפי ניהול: נוספה הפרדה בין גמ"חים פעילים לגמ"חים שנמחקו

#### 2.4.2 פוליסות אבטחה
- עודכנו פוליסות Row Level Security כדי להבטיח שרק מנהלים יכולים לצפות בגמ"חים שנמחקו
- נוספו פוליסות ייעודיות לעדכון ומחיקה של גמ"חים בסל המחזור

### 2.5 חוויית משתמש
- אישור נדרש לפני העברה לסל המחזור
- אישור נוסף נדרש לפני מחיקה סופית
- הודעות התראה ברורות לגבי השלכות הפעולות
- חיווי ויזואלי מתאים לגמ"חים בסל המחזור (אפקט opacity מופחת)

## 3. תיקונים והתאמות

### 3.1 תיקון תצוגת סטטוס בפרטי גמ"ח
- תוקנה תצוגת סטטוס הגמ"ח כך שגמ"חים שטרם אושרו (is_approved = NULL) יוצגו כ-"ממתינים לאישור" ולא כ-"נדחו"
- שופרה תצוגת ההודעות בהתאם לסטטוס, עם צבעים מתאימים ואייקונים שמסייעים בהבנת המצב

### 3.2 שיפור בתצוגת פעולות אדמין
- בדף פרטי גמ"ח, נוספה הפרדה ברורה יותר בין פעולות המוצגות למנהלים ולמשתמשים רגילים
- לכל סטטוס של גמ"ח, מוצגות רק הפעולות הרלוונטיות (אישור/דחייה רק לממתינים, עריכה לכולם, וכו')

## 4. פונקציות מסד נתונים חדשות

### 4.1 פונקציית העברה לסל מחזור
```sql
CREATE OR REPLACE FUNCTION move_gemach_to_trash(gemach_id UUID)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    is_admin BOOLEAN;
BEGIN
    -- בדיקת הרשאות מנהל
    SELECT profiles.is_admin INTO is_admin 
    FROM profiles 
    WHERE id = auth.uid();
    
    IF is_admin IS NOT TRUE THEN
        RAISE EXCEPTION 'רק מנהלי מערכת רשאים להעביר גמ"חים לסל המחזור';
    END IF;
    
    -- העברה לסל המחזור
    UPDATE gemachs 
    SET 
        is_deleted = TRUE,
        deleted_at = NOW()
    WHERE id = gemach_id;
    
    RETURN FOUND;
END;
$$;
```

### 4.2 פונקציית שחזור מסל מחזור
```sql
CREATE OR REPLACE FUNCTION restore_gemach_from_trash(gemach_id UUID)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    is_admin BOOLEAN;
BEGIN
    -- בדיקת הרשאות מנהל
    SELECT profiles.is_admin INTO is_admin 
    FROM profiles 
    WHERE id = auth.uid();
    
    IF is_admin IS NOT TRUE THEN
        RAISE EXCEPTION 'רק מנהלי מערכת רשאים לשחזר גמ"חים מסל המחזור';
    END IF;
    
    -- שחזור מסל המחזור
    UPDATE gemachs 
    SET 
        is_deleted = NULL,
        deleted_at = NULL
    WHERE id = gemach_id;
    
    RETURN FOUND;
END;
$$;
```

## 5. סיכום השינויים וההשפעות

השינויים שבוצעו משפרים באופן משמעותי את יכולות הניהול של מנהלי המערכת, ומספקים שכבת הגנה נוספת מפני מחיקה בשוגג של גמ"חים. הוספת מערכת סל המחזור מאפשרת למנהלים:

1. לשלוט טוב יותר בתוכן שמוצג במערכת
2. לערוך ולתקן גמ"חים בכל סטטוס
3. לבטל בקלות פעולות מחיקה במידת הצורך
4. לנהל ביעילות את מחזור החיים של גמ"חים במערכת

בנוסף, המערכת מעניקה שקיפות רבה יותר למשתמשים לגבי סטטוס הגמ"חים שלהם, ומשפרת את חווית המשתמש באמצעות תיקון הודעות סטטוס והבהרת מצבי גמ"ח שונים. 